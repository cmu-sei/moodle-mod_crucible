define(["jquery"],function(a){function b(){a.ajax({url:f+"/sessions/"+e+"/dispatchtaskresults",type:"GET",contentType:"application/json",dataType:"json",beforeSend:function(a){a.setRequestHeader("Authorization","Bearer "+d)},success:function(b){b.sort(function(a,b){return a.statusDate>b.statusDate?1:-1}),a.each(b,function(a,b){var c=document.getElementById("result-"+b.dispatchTaskId);c&&(c.innerHTML=b.status)})},error:function(a){"401"==a.status?(console.log("permission error, check token, reload page"),alert("permission error, check token, reload page"),clearTimeout(g)):(console.log(a),clearTimeout(g))}})}function c(b){console.log("exec task for "+b),a.ajax({url:f+"/dispatchtasks/"+b+"/execute",type:"POST",contentType:"application/json",dataType:"json",beforeSend:function(a){a.setRequestHeader("Authorization","Bearer "+d)},success:function(b){a.each(b,function(a,b){console.log(b.statusDate+" task "+b.dispatchTaskId+" status "+b.status);var c=document.getElementById("result-"+b.dispatchTaskId);c&&(c.innerHTML=b.status)})},error:function(a){"401"==a.status?(console.log("permission error, check token, reload page"),alert("permission error, check token, reload page")):"400"==a.status?(console.log(a.responseJSON),alert("Run Task command failed "+a.responseJSON.detail)):"500"==a.status&&(console.log(a.responseJSON),alert("Run Task command failed "+a.responseJSON.detail))}})}var d,e,f,g;return{init:function(h){console.log("session id "+h.session),d=h.token,e=h.session,f=h.steamfitter_api,b(),g=setInterval(function(){b()},5e3);var i=document.getElementsByClassName("exec-task");a.each(i,function(a,b){var d=b.id,e=document.getElementById(d);e&&"Run Task"===e.innerHTML&&(e.onclick=function(){c(d),console.log("set event for button "+d)})})}}});
